
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="DarkCloud">
    <title>ZeroTier in my homelab - DarkCloud</title>
    <meta name="author" content="Kim Tholstorf">
    
    
        <link rel="icon" href="darkcloud.dk/assets/images/avatar_circle.png">
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kim Tholstorf","sameAs":["https://github.com/KimTholstorf","https://twitter.com/KimTholstorf","https://facebook.com/kimtholstorf","https://www.linkedin.com/in/kimtholstorf","mailto:kim@tholstorf.dk"],"image":"avatar_circle.png"},"articleBody":"I have started to test out ZeroTier as a alternative to traditional VPN for my home lab. I’m not unhappy about how VPN works with my Ubiquity USG setup, but I need something more intrinsic and independant of whereever my workloads would run and not depend on my homelap or me connecting to it to access these. In my opinion VPN is great for high performance site-to-site tunnels or for roadworkers out and about needing to connect to the “office/data center” i.e some aggregate of workloads in close proximity. They’re not well suited for scattered ephemeral workloads and I do not want to maintain scripting handeling a cumpersome setup processes for each new VM/contrainer or VPN site-to-site tunnels between my homelab, worklab and a couple of public cloud providers (those guys even charge for VPN connections). For my requirements a simple to setup and encrypted overlay solution is a far better option as I tend to spin up short lived workloads on everything between my own raspberry pi cluster, worklab and clouds like AWS and Google.There are great VPN alternatives available like WireGuard or Tinc with powerfull features not found elswhere. Though they’re still more comparable to traditional VPN - plus they’re much more cumpersome to setup than ZeroTier.\n Anyway, let dig into ZeroTier!\n\nWhat is ZeroTier?ZeroTier is a virtual ethernet switch for global area networking built on the principle of de-perimeterisation. It’s a distributed network hypervisor built atop a cryptographically secure peer-to-peer network that spans any physical LAN/WAN boundary. It makes devices of any type and any location believe it is conneced to the same global switch. All traffic is encrypted end-to-end by the network who will try to always use the most direct path available for best latency and performance.\nAs for security I believe ZeroTier have that quite well covered as it uses one of the fastest elliptic curve cryptos for public key encryption, a 256-bit stream cipher for end-to-end packet encryption and a strong message authentication code (MAC) as well. The recent inclution of WireGuard into the mainline Linux kernel (5.6) actually benefits ZeroTier as well. Both use the Poly1305 for MAC and the people behind WireGuard have been hard at work optimizing the code and made really great performance improvements.\nThe ZeroTier encrypted peer-to-peer operate in a DNS-like “world-like topology”. There is only one planet (Earth) and ZeroTier operate the top-level root servers. Users can add their own user-defiend root servers (moons) to improve latency or to build an on-premise solution that can keep the local ZeroTier network alive despite loosing internet connectivity. Nodes are the members/devices joining a network and they can “orbit” any number of moons (i.e. use them as root servers). In typical peer-to-peer fasion roots/moons handles only direct connection route discovery and initial peer relay. They will only relay packets untill peers know a direct route between them, but as all packets are end-to-end encrypted they can’t be read by anyone else.In the upcomming ZeroTier 2.0 release the planet/moon terminology for root servers goes away.\nAs users there’s only two types of cryptographic identifiers in ZeroTier we need to know of:\n\nNode ID (a 10-digit hex address know by the user)\nNetwork IDs (16-digit hex address known by the network owner or exixting members) \n\nA Node ID address identifies a single device/member (i.e laptop, server, VM, phone) while a Network ID identifies the ZeroTier network whom devices/members can join.Another way of thinking about it that a Node IDs are switch-ports on a giant earth-sized virtual switch and network IDs are the VLANs these ports can be assigned.\nNetwork controllers are ZeroTier nodes that act as access control, certificate authorities and configuration managers of the virtual ethernet layer put ontop of the peer-to-peer network. It’s very common to mistake them for root servers, but as they’re are connection facilitators, network controllers are the config managers and certificate authorities of the virtual overlay. The first 10 digits of a Network ID is the global ZeroTier address of its controller. The rest of the ID is the unique network number on the controller. You can create networks with the controller hosted by ZeroTier for free - if you can keep under 100 devices per network (unlimited networks, though). If you want to roll your own network controller then Key Networks have made a pretty great web UI and improved the installaion process compared to what ZeroTier made available. \nUnlike a typical VPN a ZeroTier network operate pretty much as an isolated virtual switch where every authorized device can communicate with each other. Configured as a Private network only an admin can authorize new members, but a in a Public network every new device member gets immediate access. Routes and switch flow rules can be configured per network. If a more “VPN like experience” is needed a ZeroTier member can be configured by a network admin as a bridge device and via routes have straffic for specific IP ranges send to this device member. After configuring IP forwarding in the OS of the bridge it is possible to reach devices on a LAN outside the ZeroTier network. With some concurrent multipath and QoS support build into ZeroTier, you can even use it as a sort of “SD-WAN” solution when you only connect linux software routers as devices and use dynamic routing to securely connect office brances together.\nSomething that is completely missing from ZeroTier is DNS lookup. IP adresses are assigned in a DHCP-like fasion, but there is no DNS feature in ZeroTier at the moment. In my lab I run DNSMASQ and created a script that goes through all my ZeroTier networks and updates my DNS-server with all the members it finds. In a later blog article I’ll go through the scipt I created for this and other things for my ZeroTier usage.\nInstalling the clientZeroTier have packages for almost everything of interest and they provide a universal install script you can run with just a one-liner: \n1$ curl -s https://install.zerotier.com | sudo bash\n\nIf you’re not keen on just running the script without GPG verification they have you covered as well:\n1$ curl -s 'https://raw.githubusercontent.com/zerotier/ZeroTierOne/master/doc/contact%40zerotier.com.gpg' | gpg --import &amp;&amp; if z=$(curl -s 'https://install.zerotier.com/' | gpg); then echo \"$z\" | sudo bash; fi\n\nMy installation was painless thanks to the diffrent communities who made ZeroTier available as a Snap, via Homebrew for macOS and via Chocolatey for Windows. Only macOS and Windows have a desktop app with UI, and the rest have only zerotier-cli available. I did not use the ZeroTier one-liner install script as it only lets Linux machines handle future updates via a local packemanager (DEB/RPM). I wanted the same experience on all platforms, so that is why I went with Homebrew (already using it extensively) and Chocolatey.\nAnsibleIf you’re familiar with Ansible then Marcus Meurs have created a excellent role for ZeroTier you can install from Ansible Galaxy with just ansible-galaxy install m4rcu5nl.zerotier-one. Besides installing ZeroTier the role can also join the new device to a specified Network ID (though not leaving a network).\nPlaybook example:\n12345678- hosts: zerotier-servers    vars:        zerotier_network_id: 9999c2e54cc6aa7b        zerotier_accesstoken: \"&#123;&#123; vault_zerotier_accesstoken &#125;&#125;\"        zerotier_register_short_hostname: true    roles:        - &#123; role: m4rcu5nl.zerotier, become: true &#125;\n\nInventory example (YAML):\n1234567891011121314servers:  hosts:    fileserver1.domain.com:        zerotier_member_description: \"Filerserver 1\"    fileserver2.domain.com:        zerotier_member_description: \"Filerserver 2\"        zerotier_member_ip_assignments='[\"192.168.244.10\"]'desktops:    hosts:        macos.desktop.com        linux.desktop.com        windows.desktop.com      vars:        zerotier_member_description \"Just another desktop\"\n\nAnsible is almost straightforward to use and this role is quite easy to use as well. Though Ansible is not always the answer to all prayers as its build arround a push architecture and the expectation that you can reach the server via the LAN/internet or that you’re even allowed to ssh into the server. It just not all servers that can be reaced from your Ansible management node or they you are the admin. Personally I ended up writing a set of compresensive scripts for joining/authorizing members to a network. I’ll share more about these in another blogpost coming soon.\nIn the later sections for joining or leaving a network I won’t cover it from a Ansible perspective as the ansible role can handle all that. Instead I’ll try to dig into the API for these tasks. \nDockerOn Linux ZeroTier require access to the /dev/net/tun interface on the host to create the virtual zt* interface. This is a challenge because running it in a container will then require priveledged access to the host. For now I can only get ZeroTier to work in Docker by running it with a few runtime capabilities (SYS_ADMIN and NET_ADMIN) so it can access and modify the host network interfaces. It is still not full priveledged access, but close and it is definately not best practice… not at all…I doubt I will be possible to circumvent this with Docker alone, so later in the future I’ll try to see if is possible mitigate the risc via a micro-vm based container solution like Firecracker / Ignite or Nautilus / Project pasific. It all depends on any of these micro-vm have the TUN interface exposed/impemented in their kernels.\nTo prevent a container from generating a new node ID (device member ID) at reach run, then mount /var/lib/zerotier-one from the Docker host for persistant conifg.\nFor container images I prefer Alpine over my usual choice of Ubuntu/Debian for everything not macOS. I really want this to be able to run on any CPU architecture you can thow at Docker (yes, even a Raspberry Pi), but Apline only have community packages for x86_64 and ppc. Thankfully ZeroTier they have their own multi-arch debian reposotory, so combined with Docker buildx I will use multistage-build (for each platform) to install the correct binaries in a temporary Debian image and them copy them over to the final Alpine image.\n1234567891011121314151617181920212223242526272829FROM --platform=$BUILDPLATFORM debian:buster-slim AS buildstageENV ZEROTIER_VERSION=1.4.6RUN apt-get update &amp;&amp; apt-get install -y curl gnupg &amp;&amp; \\    apt-key adv --keyserver ha.pool.sks-keyservers.net --recv-keys 0x1657198823e52a61  &amp;&amp; \\    echo \"deb http://download.zerotier.com/debian/buster buster main\" &gt; /etc/apt/sources.list.d/zerotier.list &amp;&amp; \\    apt-get update &amp;&amp; apt-get install -y zerotier-one=$ZEROTIER_VERSIONCOPY main.sh /var/lib/zerotier-one/main.shFROM alpine:latestLABEL VERSION=\"1.4.6\"LABEL MAINTAINER=\"kim@tholstorf.dk\"LABEL DISCRIPTION=\"Containerized ZeroTier for Docker Linux hosts. NOTE: Needs to run with priviledged network access to work :(\"##   docker run --name zerotier-one \\##              --device=/dev/net/tun --net=host --cap-add=NET_ADMIN --cap-add=SYS_ADMIN \\##              --volume=/var/lib/zerotier-one:/var/lib/zerotier-one kimtholstorf/zerotierRUN apk add --update --no-cache libgcc libc6-compat libstdc++RUN mkdir -p /var/lib/zerotier-oneCOPY --from=buildstage /usr/sbin/zerotier-one /usr/sbin/zerotier-oneCOPY --from=buildstage /usr/sbin/zerotier-cli /usr/sbin/zerotier-cliCOPY --from=buildstage /usr/sbin/zerotier-idtool /usr/sbin/zerotier-idtoolCOPY --from=buildstage /var/lib/zerotier-one/main.sh /main.shRUN chmod 0755 /main.shEXPOSE 9993/udpENTRYPOINT [\"/main.sh\"]CMD [\"zerotier-one\"]\n\nThis will soon be available on Docker Hub at kimtholstorf/docker-zerotier. Though be carefull unstill there is a stable release.\nCreate a networkFirst you’ll need to create an account on my.zerotier.com. If you’re expecting to use the API for scripting then go to the Account page and click + Create Access Token. The API documentation is available here.\nThere’s two kind of networks:\n\nPublic network can anyone join without authorization and get access. \nPrivate networks can anyone join, but they need to be authorized by the network owner or delegated users to be able to communicate with other members.\n\nWebIU\nOn the Networks page on my.zerotier.com click Create a Network. A new private network with a unique Network ID and random generated name will be spun up. Under the network you can change name, description and advanced settings such as IP assignments, routes or share the network with other users and assign permissions. This is also here members will show up after they have joined and where indivudual member settings are configured.\nAPI/CLI\nTo create a new private network just run the below curl command against the Zerotier API URL with your &lt;API-ACCESS-TOKEN&gt; and your desired &lt;NETWORK-NAME&gt;. Change the private value to false to create a public network. Just posting empty JSON data &#39;{}&#39; will create a new public network, but with a blank name field. \n1$ curl -H \"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;\" -X POST -d '&#123;\"config\":&#123;\"name\":\"&lt;NETWORK-NAME&gt;\",\"private\":true&#125;&#125;' https://my.zerotier.com/api/network\n\nJoin a networkWebIU\nTo “join” a client to a network from my.zerotier.com you need to know the 10-hex-digit Node ID of the client. Windows and macOS users can see this ID in the ZeroTier-One desktop app. Linux users or cli advocates can get their ID via the zerotier-cli commandline tool (also available on Windows and macOS).\n1$ zerotier-cli info | cut -d \" \" -f 3\n\nIn the settings section under each network (nearly at the botton) there’s a &#39;Manually Add Member&#39; field. And, yes there’s actually 2 fields to add a member but they do the same. Put in the Node ID of the member and click Submit`/`Add New Member.NOTE: This wil not actually join the member but will pre-authorize so that when the member joins they’re already authorized and able to use the network.It’s also possible to send a user a e-mail invitation with join instructions and it makes sense to manually add (i.e pre-authorize) the member, so when they follow the join instructions they’re already authendicated.\nAPI/CLITo actually join a network from a client you need to know the 16-hex-digit Network ID of the network. If you been invited via e-mail the Network ID is included along with join instructions. For existing members or admins the ID is available from the ZeroTier WebUI under Networks or via the zerotier-cli commandline tool.\n1$ zerotier-cli listnetworks\n\nTo join run:\n1$ zerotier-cli join &lt;NETWORK-ID&gt;\n\nIf you’re an admin you can authorize a member via this curl command:\n1$ curl -H \"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;\" -X POST -d '&#123;\"name\":\"short-name\",\"description\":\"long-description\",\"config\":&#123;\"authorized\":true&#125;&#125;' https://my.zerotier.com/api/network/&lt;NETWORK-ID&gt;/member/&lt;NODE-ID&gt;\n\nThis only works if the member is already joined, though not authorized. In the example above I also configure a name and description for the new member. Just posting &#39;{&quot;config&quot;:{&quot;authorized&quot;:true}}&#39; as JSON data vill just authorize a member. \nIn a later post I’ll share a script I wrote that’ll join a member, then wait for the succes responce and finally authorize same member.\nLeave a networkA network member can via the zerotier-cli commandline tool or desktop UI leave a network of their own volition.\nIf you’re a network owner/admin you have three options to remove access for a member\n\nDeauthorize a member\nHide a member\nBan a member\n\nAny of the options will take a couple of minutes to take effect on the client side.Strangely enough I haven’t found any API reference to banning a member, though it is available as an option in the WebUI.\nWebIU\nDeauthorizing a member will basically revert it back to the initial joined state without a assigned IP or ability to communicate with other members.Hiding a member will deauthorize it and hide it from view. Hidden members can be found by selecting the hidden checkmark in the member list and here can they be unhidden and authorized again (2-click process).Banning a member will deauthorize it and permantly hide it from view. The member have to be manually added to the network to regain access.\nAPI/CLI\nFor a member to leave a network run:\n1$ zerotier-cli leave &lt;NETWORK-ID&gt;\n\nIf you’re an admin you can hide a member:\n1$ curl -H \"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;\" -X POST -d '&#123;\"hidden\":true&#125;' https://my.zerotier.com/api/network/&lt;NETWORK-ID&gt;/member/&lt;NODE-ID&gt;\n\nTo unhide a member and authorize them again:\n1$ curl -H \"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;\" -X POST -d '&#123;\"hidden\":false,\"config\":&#123;\"authorized\":true&#125;&#125;' https://my.zerotier.com/api/network/&lt;NETWORK-ID&gt;/member/&lt;NODE-ID&gt;\n\nI think that is enough for now. In my next blog article I’ll go through the scripts I created to automatically join a network and create DNS records in DNSMASQ.\n","dateCreated":"2020-02-05T03:30:00+01:00","dateModified":"2020-02-04T03:21:16+01:00","datePublished":"2020-02-05T03:30:00+01:00","description":"I have started to test out ZeroTier as a alternative to traditional VPN for my home lab. I’m not unhappy about how VPN works with my Ubiquity USG setup, but I need something more intrinsic and independant of whereever my workloads would run and not depend on my homelap or me connecting to it to access these. In my opinion VPN is great for high performance site-to-site tunnels or for roadworkers out and about needing to connect to the “office/data center” i.e some aggregate of workloads in close proximity. They’re not well suited for scattered ephemeral workloads and I do not want to maintain scripting handeling a cumpersome setup processes for each new VM/contrainer or VPN site-to-site tunnels between my homelab, worklab and a couple of public cloud providers (those guys even charge for VPN connections). For my requirements a simple to setup and encrypted overlay solution is a far better option as I tend to spin up short lived workloads on everything between my own raspberry pi cluster, worklab and clouds like AWS and Google.There are great VPN alternatives available like WireGuard or Tinc with powerfull features not found elswhere. Though they’re still more comparable to traditional VPN - plus they’re much more cumpersome to setup than ZeroTier.\n Anyway, let dig into ZeroTier!","headline":"ZeroTier in my homelab","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"/darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/"},"publisher":{"@type":"Organization","name":"Kim Tholstorf","sameAs":["https://github.com/KimTholstorf","https://twitter.com/KimTholstorf","https://facebook.com/kimtholstorf","https://www.linkedin.com/in/kimtholstorf","mailto:kim@tholstorf.dk"],"image":"avatar_circle.png","logo":{"@type":"ImageObject","url":"avatar_circle.png"}},"url":"/darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/","keywords":"zerotier, long-read, docker"}</script>
    <meta name="description" content="I have started to test out ZeroTier as a alternative to traditional VPN for my home lab. I’m not unhappy about how VPN works with my Ubiquity USG setup, but I need something more intrinsic and indepen">
<meta name="keywords" content="zerotier,long-read,docker">
<meta property="og:type" content="blog">
<meta property="og:title" content="ZeroTier in my homelab">
<meta property="og:url" content="darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/index.html">
<meta property="og:site_name" content="DarkCloud">
<meta property="og:description" content="I have started to test out ZeroTier as a alternative to traditional VPN for my home lab. I’m not unhappy about how VPN works with my Ubiquity USG setup, but I need something more intrinsic and indepen">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-02-04T02:21:16.522Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ZeroTier in my homelab">
<meta name="twitter:description" content="I have started to test out ZeroTier as a alternative to traditional VPN for my home lab. I’m not unhappy about how VPN works with my Ubiquity USG setup, but I need something more intrinsic and indepen">
<meta name="twitter:creator" content="@KimTholstorf">
    
    
        
    
    
        <meta property="og:image" content="darkcloud.dk/assets/images/avatar_circle.png"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-c4ozcsklz4kht2pebhp44xorvyverh23toayhn7i6ubrpyedak24hv1v0hyd.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-131086114-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-131086114-1');
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">DarkCloud</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar_circle.png" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="3">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar_circle.png" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Kim Tholstorf</h4>
                
                    <h5 class="sidebar-profile-bio"><p>passionate about most cloud native technologies, my family, friends and great books</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/KimTholstorf" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/KimTholstorf" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://facebook.com/kimtholstorf" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/kimtholstorf" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:kim@tholstorf.dk" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            ZeroTier in my homelab
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-02-05T03:30:00+01:00">
	
		    Feb 05, 2020
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>I have started to test out ZeroTier as a alternative to traditional VPN for my home lab. I’m not unhappy about how VPN works with my Ubiquity USG setup, but I need something more intrinsic and independant of whereever my workloads would run and not depend on my homelap or me connecting to it to access these. In my opinion VPN is great for high performance site-to-site tunnels or for roadworkers out and about needing to connect to the “office/data center” i.e some aggregate of workloads in close proximity. They’re not well suited for scattered ephemeral workloads and I do not want to maintain scripting handeling a cumpersome setup processes for each new VM/contrainer or VPN site-to-site tunnels between my homelab, worklab and a couple of public cloud providers (those guys even charge for VPN connections). For my requirements a simple to setup and encrypted overlay solution is a far better option as I tend to spin up short lived workloads on everything between my own raspberry pi cluster, worklab and clouds like AWS and Google.<br>There are great VPN alternatives available like <a href="https://www.wireguard.com/netns/" target="_blank" rel="noopener">WireGuard</a> or <a href="https://tinc-vpn.org/" target="_blank" rel="noopener">Tinc</a> with powerfull features not found elswhere. Though they’re still more comparable to traditional VPN - plus they’re much more cumpersome to setup than ZeroTier.</p>
<p> Anyway, let dig into ZeroTier!</p>
<a id="more"></a>
<h4 id="What-is-ZeroTier"><a href="#What-is-ZeroTier" class="headerlink" title="What is ZeroTier?"></a><strong>What is ZeroTier?</strong></h4><p>ZeroTier is a virtual ethernet switch for global area networking built on the principle of <a href="https://en.wikipedia.org/wiki/De-perimeterisation" target="_blank" rel="noopener">de-perimeterisation</a>. It’s a distributed network hypervisor built atop a cryptographically secure peer-to-peer network that spans any physical LAN/WAN boundary. It makes devices of any type and any location believe it is conneced to the same global switch. All traffic is encrypted end-to-end by the network who will try to always use the most direct path available for best latency and performance.</p>
<p>As for security I believe ZeroTier have that quite well covered as it uses one of the <a href="https://en.wikipedia.org/wiki/Curve25519" target="_blank" rel="noopener">fastest elliptic curve cryptos</a> for public key encryption, a <a href="https://en.wikipedia.org/wiki/Salsa20" target="_blank" rel="noopener">256-bit stream cipher</a> for end-to-end packet encryption and a strong <a href="https://en.wikipedia.org/wiki/Poly1305" target="_blank" rel="noopener">message authentication code</a> (MAC) as well. The recent <a href="https://github.com/torvalds/linux/commit/bd2463ac7d7ec51d432f23bf0e893fb371a908cd" target="_blank" rel="noopener">inclution</a> of WireGuard into the mainline Linux kernel (5.6) actually benefits ZeroTier as well. Both use the Poly1305 for MAC and the people behind WireGuard have been hard at work optimizing the code and made really great <a href="https://git.kernel.org/pub/scm/linux/kernel/git/herbert/cryptodev-2.6.git/commit/?id=d7d7b853566254648df59f7ea27ea05952a6cfa8" target="_blank" rel="noopener">performance improvements</a>.</p>
<p>The ZeroTier encrypted peer-to-peer operate in a DNS-like “world-like topology”. There is only one planet (Earth) and ZeroTier operate the top-level root servers. Users can add their own user-defiend root servers (moons) to improve latency or to build an on-premise solution that can keep the local ZeroTier network alive despite loosing internet connectivity. Nodes are the members/devices joining a network and they can “orbit” any number of moons (i.e. use them as root servers). In typical peer-to-peer fasion roots/moons handles only direct connection route discovery and initial peer relay. They will only relay packets untill peers know a direct route between them, but as all packets are end-to-end encrypted they can’t be read by anyone else.<br>In the upcomming ZeroTier 2.0 release the planet/moon terminology for root servers <a href="https://www.zerotier.com/zerotier-2-0-status/" target="_blank" rel="noopener">goes away</a>.</p>
<p>As users there’s only two types of cryptographic identifiers in ZeroTier we need to know of:</p>
<ul>
<li>Node ID (a 10-digit hex address know by the user)</li>
<li>Network IDs (16-digit hex address known by the network owner or exixting members) </li>
</ul>
<p>A Node ID address identifies a single device/member (i.e laptop, server, VM, phone) while a Network ID identifies the ZeroTier network whom devices/members can join.<br>Another way of thinking about it that a Node IDs are switch-ports on a giant earth-sized virtual switch and network IDs are the VLANs these ports can be assigned.</p>
<p>Network controllers are ZeroTier nodes that act as access control, certificate authorities and configuration managers of the virtual ethernet layer put ontop of the peer-to-peer network. It’s very common to mistake them for root servers, but as they’re are connection facilitators, network controllers are the config managers and certificate authorities of the virtual overlay. The first 10 digits of a Network ID is the global ZeroTier address of its controller. The rest of the ID is the unique network number on the controller. You can create networks with the controller <a href="https://my.zerotier.com/" target="_blank" rel="noopener">hosted by ZeroTier</a> for free - if you can keep under 100 devices per network (unlimited networks, though). If you want to roll your <a href="https://github.com/zerotier/ZeroTierOne/tree/master/controller" target="_blank" rel="noopener">own network controller</a> then Key Networks have made a pretty great <a href="https://key-networks.com/ztncui/" target="_blank" rel="noopener">web UI</a> and improved the <a href="https://github.com/key-networks/ztncui-containerized" target="_blank" rel="noopener">installaion process</a> compared to what <a href="https://github.com/zerotier/ZeroTierOne/tree/master/controller" target="_blank" rel="noopener">ZeroTier made available</a>. </p>
<p>Unlike a typical VPN a ZeroTier network operate pretty much as an isolated virtual switch where every authorized device can communicate with each other. Configured as a Private network only an admin can authorize new members, but a in a Public network every new device member gets immediate access. Routes and switch flow rules can be configured per network. If a more “VPN like experience” is needed a ZeroTier member can be configured by a network admin as a bridge device and via routes have straffic for specific IP ranges send to this device member. After <a href="https://www.reddit.com/r/zerotier/comments/9714a2/easy_way_of_bridging_lan_for_remote_access/" target="_blank" rel="noopener">configuring IP forwarding</a> in the OS of the bridge it is possible to reach devices on a LAN outside the ZeroTier network. With some concurrent multipath and QoS support build into ZeroTier, you can even use it as a <em>sort of</em> “SD-WAN” solution when you only connect linux software routers as devices and use dynamic routing to <a href="https://mindlesstux.com/2018/09/23/zerotier-multsite-lan-part-1-zerotier-and-making-a-multi-site-lan-man/" target="_blank" rel="noopener">securely connect office brances together</a>.</p>
<p>Something that is <strong>completely</strong> missing from ZeroTier is DNS lookup. IP adresses are assigned in a DHCP-like fasion, but there is no DNS feature in ZeroTier at the moment. In my lab I run <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html" target="_blank" rel="noopener">DNSMASQ</a> and created a script that goes through all my ZeroTier networks and updates my DNS-server with all the members it finds. In a later blog article I’ll go through the scipt I created for this and other things for my ZeroTier usage.</p>
<h4 id="Installing-the-client"><a href="#Installing-the-client" class="headerlink" title="Installing the client"></a><strong>Installing the client</strong></h4><p>ZeroTier have <a href="https://zerotier.com/download/" target="_blank" rel="noopener">packages</a> for almost everything of interest and they provide a universal install script you can run with just a one-liner: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s https://install.zerotier.com | sudo bash</span><br></pre></td></tr></table></figure>

<p>If you’re not keen on just running the script without GPG verification they have you covered as well:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s <span class="string">'https://raw.githubusercontent.com/zerotier/ZeroTierOne/master/doc/contact%40zerotier.com.gpg'</span> | gpg --import &amp;&amp; <span class="keyword">if</span> z=$(curl -s <span class="string">'https://install.zerotier.com/'</span> | gpg); <span class="keyword">then</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$z</span>"</span> | sudo bash; <span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>My installation was painless thanks to the diffrent communities who made ZeroTier available as a <a href="https://snapcraft.io/zerotier-one" target="_blank" rel="noopener">Snap</a>, via <a href="https://formulae.brew.sh/cask/zerotier-one" target="_blank" rel="noopener">Homebrew</a> for macOS and via <a href="https://chocolatey.org/packages/zerotier-one/" target="_blank" rel="noopener">Chocolatey</a> for Windows. Only macOS and Windows have a desktop app with UI, and the rest have only <code>zerotier-cli</code> available. I did not use the ZeroTier one-liner install script as it only lets Linux machines handle future updates via a local packemanager (DEB/RPM). I wanted the same experience on all platforms, so that is why I went with <a href="https://brew.sh" target="_blank" rel="noopener">Homebrew</a> (already using it extensively) and <a href="https://chocolatey.org" target="_blank" rel="noopener">Chocolatey</a>.</p>
<p><strong>Ansible</strong><br>If you’re familiar with Ansible then <a href="https://github.com/m4rcu5nl" target="_blank" rel="noopener">Marcus Meurs</a> have created a <a href="https://github.com/m4rcu5nl/ansible-role-zerotier" target="_blank" rel="noopener">excellent role</a> for ZeroTier you can install from <a href="https://galaxy.ansible.com/m4rcu5nl/zerotier-one" target="_blank" rel="noopener">Ansible Galaxy</a> with just <code>ansible-galaxy install m4rcu5nl.zerotier-one</code>. Besides installing ZeroTier the role can also join the new device to a specified Network ID (though not leaving a network).</p>
<p>Playbook example:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">zerotier-servers</span></span><br><span class="line"><span class="attr">    vars:</span></span><br><span class="line"><span class="attr">        zerotier_network_id:</span> <span class="number">9999</span><span class="string">c2e54cc6aa7b</span></span><br><span class="line"><span class="attr">        zerotier_accesstoken:</span> <span class="string">"<span class="template-variable">&#123;&#123; vault_zerotier_accesstoken &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">        zerotier_register_short_hostname:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    roles:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">m4rcu5nl.zerotier,</span> <span class="attr">become:</span> <span class="literal">true</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Inventory example (YAML):</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">servers:</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line">    <span class="string">fileserver1.domain.com:</span></span><br><span class="line"><span class="attr">        zerotier_member_description:</span> <span class="string">"Filerserver 1"</span></span><br><span class="line">    <span class="string">fileserver2.domain.com:</span></span><br><span class="line"><span class="attr">        zerotier_member_description:</span> <span class="string">"Filerserver 2"</span></span><br><span class="line">        <span class="string">zerotier_member_ip_assignments='["192.168.244.10"]'</span></span><br><span class="line"><span class="attr">desktops:</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line">        <span class="string">macos.desktop.com</span></span><br><span class="line">        <span class="string">linux.desktop.com</span></span><br><span class="line">        <span class="string">windows.desktop.com</span></span><br><span class="line"><span class="attr">      vars:</span></span><br><span class="line">        <span class="string">zerotier_member_description</span> <span class="string">"Just another desktop"</span></span><br></pre></td></tr></table></figure>

<p>Ansible is <em>almost</em> straightforward to use and this role is quite easy to use as well. Though Ansible is not always the answer to all prayers as its build arround a push architecture and the expectation that you can reach the server via the LAN/internet or that you’re even allowed to ssh into the server. It just not all servers that can be reaced from your Ansible management node or they you are the admin. Personally I ended up writing a set of compresensive scripts for joining/authorizing members to a network. <em>I’ll share more about these in another blogpost coming soon.</em></p>
<p>In the later sections for joining or leaving a network I won’t cover it from a Ansible perspective as the ansible role can handle all that. Instead I’ll try to dig into the API for these tasks. </p>
<p><strong>Docker</strong><br>On Linux ZeroTier require access to the <code>/dev/net/tun</code> interface on the host to create the virtual zt* interface. This is a challenge because running it in a container will then require priveledged access to the host. For now I can only get ZeroTier to work in Docker by running it with a few runtime capabilities (SYS_ADMIN and NET_ADMIN) so it can access and modify the host network interfaces. It is still not full priveledged access, but close and it is definately <strong>not</strong> best practice… not at all…<br>I doubt I will be possible to circumvent this with Docker alone, so later in the future I’ll try to see if is possible mitigate the risc via a micro-vm based container solution like <a href="https://firecracker-microvm.github.io/" target="_blank" rel="noopener">Firecracker</a> / <a href="https://github.com/weaveworks/ignite" target="_blank" rel="noopener">Ignite</a> or <a href="https://github.com/VMwareFusion/nautilus" target="_blank" rel="noopener">Nautilus</a> / <a href="https://blogs.vmware.com/vsphere/2019/08/project-pacific-technical-overview.html" target="_blank" rel="noopener">Project pasific</a>. It all depends on any of these micro-vm have the TUN interface exposed/impemented in their kernels.</p>
<p>To prevent a container from generating a new node ID (device member ID) at reach run, then mount /var/lib/zerotier-one from the Docker host for persistant conifg.</p>
<p>For container images I prefer Alpine over my usual choice of Ubuntu/Debian for everything not macOS. I really want this to be able to run on any CPU architecture you can thow at Docker (yes, even a Raspberry Pi), but Apline only have community packages for <a href="https://pkgs.alpinelinux.org/packages?name=zerotier*&branch=edge" target="_blank" rel="noopener">x86_64 and ppc</a>. Thankfully ZeroTier they have their own multi-arch <a href="http://download.zerotier.com/debian/buster" target="_blank" rel="noopener">debian reposotory</a>, so combined with Docker <a href="https://docs.docker.com/buildx/working-with-buildx/" target="_blank" rel="noopener">buildx</a> I will use <a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener">multistage-build</a> (for each platform) to install the correct binaries in a temporary Debian image and them copy them over to the final Alpine image.</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> --platform=$BUILDPLATFORM debian:buster-slim AS buildstage</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> ZEROTIER_VERSION=<span class="number">1.4</span>.<span class="number">6</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y curl gnupg &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-key adv --keyserver ha.pool.sks-keyservers.net --recv-keys 0x1657198823e52a61  &amp;&amp; \</span></span><br><span class="line"><span class="bash">    <span class="built_in">echo</span> <span class="string">"deb http://download.zerotier.com/debian/buster buster main"</span> &gt; /etc/apt/sources.list.d/zerotier.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get update &amp;&amp; apt-get install -y zerotier-one=<span class="variable">$ZEROTIER_VERSION</span></span></span><br><span class="line"><span class="bash">COPY main.sh /var/lib/zerotier-one/main.sh</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">FROM alpine:latest</span></span><br><span class="line"><span class="bash">LABEL VERSION=<span class="string">"1.4.6"</span></span></span><br><span class="line"><span class="bash">LABEL MAINTAINER=<span class="string">"kim@tholstorf.dk"</span></span></span><br><span class="line"><span class="bash">LABEL DISCRIPTION=<span class="string">"Containerized ZeroTier for Docker Linux hosts. NOTE: Needs to run with priviledged network access to work :("</span></span></span><br><span class="line"><span class="bash"><span class="comment">##   docker run --name zerotier-one \</span></span></span><br><span class="line"><span class="bash"><span class="comment">##              --device=/dev/net/tun --net=host --cap-add=NET_ADMIN --cap-add=SYS_ADMIN \</span></span></span><br><span class="line"><span class="bash"><span class="comment">##              --volume=/var/lib/zerotier-one:/var/lib/zerotier-one kimtholstorf/zerotier</span></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN apk add --update --no-cache libgcc libc6-compat libstdc++</span></span><br><span class="line"><span class="bash">RUN mkdir -p /var/lib/zerotier-one</span></span><br><span class="line"><span class="bash">COPY --from=buildstage /usr/sbin/zerotier-one /usr/sbin/zerotier-one</span></span><br><span class="line"><span class="bash">COPY --from=buildstage /usr/sbin/zerotier-cli /usr/sbin/zerotier-cli</span></span><br><span class="line"><span class="bash">COPY --from=buildstage /usr/sbin/zerotier-idtool /usr/sbin/zerotier-idtool</span></span><br><span class="line"><span class="bash">COPY --from=buildstage /var/lib/zerotier-one/main.sh /main.sh</span></span><br><span class="line"><span class="bash">RUN chmod 0755 /main.sh</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">EXPOSE 9993/udp</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">ENTRYPOINT [<span class="string">"/main.sh"</span>]</span></span><br><span class="line"><span class="bash">CMD [<span class="string">"zerotier-one"</span>]</span></span><br></pre></td></tr></table></figure>

<p>This will soon be available on Docker Hub at <a href="https://hub.docker.com/r/kimtholstorf/docker-zerotier/" target="_blank" rel="noopener">kimtholstorf/docker-zerotier</a>. Though be carefull unstill there is a stable release.</p>
<h4 id="Create-a-network"><a href="#Create-a-network" class="headerlink" title="Create a network"></a><strong>Create a network</strong></h4><p>First you’ll need to create an account on <a href="https://my.zerotier.com/" target="_blank" rel="noopener">my.zerotier.com</a>. If you’re expecting to use the API for scripting then go to the Account page and click <code>+ Create Access Token</code>. The API documentation is <a href="https://my.zerotier.com/help/api" target="_blank" rel="noopener">available here</a>.</p>
<p>There’s two kind of networks:</p>
<ul>
<li>Public network can anyone join without authorization and get access. </li>
<li>Private networks can anyone join, but they need to be authorized by the network owner or delegated users to be able to communicate with other members.</li>
</ul>
<p><strong>WebIU</strong></p>
<p>On the Networks page on <a href="https://my.zerotier.com/" target="_blank" rel="noopener">my.zerotier.com</a> click <code>Create a Network</code>. A new private network with a unique Network ID and random generated name will be spun up. Under the network you can change name, description and advanced settings such as IP assignments, routes or share the network with other users and assign permissions. This is also here members will show up after they have joined and where indivudual member settings are configured.</p>
<p><strong>API/CLI</strong></p>
<p>To create a new private network just run the below curl command against the Zerotier API URL with your <code>&lt;API-ACCESS-TOKEN&gt;</code> and your desired <code>&lt;NETWORK-NAME&gt;</code>. Change the private value to <code>false</code> to create a public network. Just posting empty JSON data <code>&#39;{}&#39;</code> will create a new public network, but with a blank name field. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H <span class="string">"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;"</span> -X POST -d <span class="string">'&#123;"config":&#123;"name":"&lt;NETWORK-NAME&gt;","private":true&#125;&#125;'</span> https://my.zerotier.com/api/network</span><br></pre></td></tr></table></figure>

<h4 id="Join-a-network"><a href="#Join-a-network" class="headerlink" title="Join a network"></a><strong>Join a network</strong></h4><p><strong>WebIU</strong></p>
<p>To “join” a client to a network from <a href="https://my.zerotier.com/" target="_blank" rel="noopener">my.zerotier.com</a> you need to know the 10-hex-digit Node ID of the client. Windows and macOS users can see this ID in the ZeroTier-One desktop app. Linux users or cli advocates can get their ID via the <code>zerotier-cli</code> commandline tool (also available on Windows and macOS).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zerotier-cli info | cut -d <span class="string">" "</span> -f 3</span><br></pre></td></tr></table></figure>

<p>In the settings section under each network (nearly at the botton) there’s a <code>&#39;Manually Add Member&#39;</code> field. And, yes there’s actually 2 fields to add a member but they do the same. Put in the Node ID of the member and click <code>Submit`/`Add New Member</code>.<br><em><strong>NOTE:</strong> This wil <strong>not</strong> actually join the member but will pre-authorize so that when the member joins they’re already authorized and able to use the network.</em><br>It’s also possible to send a user a e-mail invitation with join instructions and it makes sense to manually add (i.e pre-authorize) the member, so when they follow the join instructions they’re already authendicated.</p>
<h5 id="API-CLI"><a href="#API-CLI" class="headerlink" title="API/CLI"></a><strong>API/CLI</strong></h5><p>To actually join a network from a client you need to know the 16-hex-digit Network ID of the network. If you been invited via e-mail the Network ID is included along with join instructions. For existing members or admins the ID is available from the ZeroTier WebUI under Networks or via the <code>zerotier-cli</code> commandline tool.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zerotier-cli listnetworks</span><br></pre></td></tr></table></figure>

<p>To join run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zerotier-cli join &lt;NETWORK-ID&gt;</span><br></pre></td></tr></table></figure>

<p>If you’re an admin you can authorize a member via this curl command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H <span class="string">"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;"</span> -X POST -d <span class="string">'&#123;"name":"short-name","description":"long-description","config":&#123;"authorized":true&#125;&#125;'</span> https://my.zerotier.com/api/network/&lt;NETWORK-ID&gt;/member/&lt;NODE-ID&gt;</span><br></pre></td></tr></table></figure>

<p>This only works if the member is already joined, though not authorized. In the example above I also configure a name and description for the new member. Just posting <code>&#39;{&quot;config&quot;:{&quot;authorized&quot;:true}}&#39;</code> as JSON data vill just authorize a member. </p>
<p><em>In a later post I’ll share a script I wrote that’ll join a member, then wait for the succes responce and finally authorize same member.</em></p>
<h4 id="Leave-a-network"><a href="#Leave-a-network" class="headerlink" title="Leave a network"></a><strong>Leave a network</strong></h4><p>A network member can via the <code>zerotier-cli</code> commandline tool or desktop UI leave a network of their own volition.</p>
<p>If you’re a network owner/admin you have three options to remove access for a member</p>
<ul>
<li>Deauthorize a member</li>
<li>Hide a member</li>
<li>Ban a member</li>
</ul>
<p>Any of the options will take a couple of minutes to take effect on the client side.<br>Strangely enough I haven’t found any API reference to banning a member, though it is available as an option in the WebUI.</p>
<p><strong>WebIU</strong></p>
<p>Deauthorizing a member will basically revert it back to the initial joined state without a assigned IP or ability to communicate with other members.<br>Hiding a member will deauthorize it and hide it from view. Hidden members can be found by selecting the <code>hidden</code> checkmark in the member list and here can they be unhidden and authorized again (2-click process).<br>Banning a member will deauthorize it and permantly hide it from view. The member have to be manually added to the network to regain access.</p>
<p><strong>API/CLI</strong></p>
<p>For a member to leave a network run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zerotier-cli leave &lt;NETWORK-ID&gt;</span><br></pre></td></tr></table></figure>

<p>If you’re an admin you can hide a member:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H <span class="string">"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;"</span> -X POST -d <span class="string">'&#123;"hidden":true&#125;'</span> https://my.zerotier.com/api/network/&lt;NETWORK-ID&gt;/member/&lt;NODE-ID&gt;</span><br></pre></td></tr></table></figure>

<p>To unhide a member and authorize them again:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -H <span class="string">"Authorization: Bearer &lt;API-ACCESS-TOKEN&gt;"</span> -X POST -d <span class="string">'&#123;"hidden":false,"config":&#123;"authorized":true&#125;&#125;'</span> https://my.zerotier.com/api/network/&lt;NETWORK-ID&gt;/member/&lt;NODE-ID&gt;</span><br></pre></td></tr></table></figure>

<p>I think that is enough for now. In my next blog article I’ll go through the scripts I created to automatically join a network and create DNS records in DNSMASQ.</p>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/docker/">docker</a> <a class="tag tag--primary tag--small t-link" href="/tags/long-read/">long-read</a> <a class="tag tag--primary tag--small t-link" href="/tags/zerotier/">zerotier</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/12/21/Hello-World/" data-tooltip="Hello World" aria-label="NEXT: Hello World">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/" title="Share on Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Kim Tholstorf. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/12/21/Hello-World/" data-tooltip="Hello World" aria-label="NEXT: Hello World">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/" title="Share on Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="3">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/">
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/">
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/">
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar_circle.png" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Kim Tholstorf</h4>
        
            <div id="about-card-bio"><p>passionate about most cloud native technologies, my family, friends and great books</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Senior Systems Engineer @ <a href="https://vmware.com">VMware</a></p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Denmark, Copenhagen
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/forestcover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-dbd16rvloemmuxdzniplmnxxvwoz24eya9wol0b7vvmlokgqsjivmb8dnscy.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'darkcloud.dk/2020/02/05/ZeroTier-in-the-homelab/';
                 
                    this.page.identifier = '2020/02/05/ZeroTier-in-the-homelab/';
                 
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'darkcloud_dk';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



    </body>
</html>
